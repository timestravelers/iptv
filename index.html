<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>IPTV Smart TV FINAL</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
:root{--bg:#0f172a;--fg:#e5e7eb;--card:#020617;--accent:#2563eb}
.light{--bg:#f8fafc;--fg:#020617;--card:#e5e7eb}
body{margin:0;font-family:Arial;background:var(--bg);color:var(--fg)}
header,footer{background:var(--card);padding:10px 16px;display:flex;justify-content:space-between}
#container{display:flex;height:calc(100vh - 100px)}
#playlist{width:360px;overflow-y:auto}
.category{padding:8px;font-weight:bold;background:rgba(255,255,255,.08)}
.channel{display:flex;gap:10px;align-items:center;padding:10px;cursor:pointer}
.channel:focus{outline:3px solid var(--accent)}
.channel img{width:48px;height:48px;border-radius:6px;background:#fff}
#player{flex:1;position:relative}
video{width:100%;height:100%;background:black}
#zap{position:absolute;bottom:120px;left:30px;background:rgba(0,0,0,.75);padding:15px;border-radius:10px;display:none}
#zap.show{display:flex;gap:15px}
#zap img{width:64px;height:64px;background:#fff;border-radius:8px}
#error{display:none;position:absolute;inset:0;background:rgba(0,0,0,.7);align-items:center;justify-content:center}
#error .box{background:var(--card);padding:20px;border-radius:10px;text-align:center}
button{background:var(--accent);color:#fff;border:none;border-radius:6px;padding:8px 12px}
</style>
</head>

<body>

<header>
<b>üì∫ IPTV SMART TV</b>
<div>
<button onclick="toggleTheme()">üåô</button>
<button onclick="openSettings()">‚öôÔ∏è</button>
</div>
</header>

<div id="container">
<div id="playlist"></div>

<div id="player">
<video id="video" playsinline muted></video>

<div id="zap">
<img id="zapLogo">
<div>
<b id="zapName"></b><br>
<span id="zapGroup"></span>
</div>
</div>

<div id="error">
<div class="box">
<h3>‚ö†Ô∏è Stream Error</h3>
<p id="errorMsg"></p>
<button onclick="zapNext()">‚ñ∂ Channel Berikutnya</button>
</div>
</div>
</div>
</div>

<footer>
Creativityright by M. Thorik - Donasi DANA 087888879016
</footer>

<script>
/* ================= CONFIG ================= */
let cfg = JSON.parse(localStorage.getItem('cfg')) || { theme:'dark', m3u:'' };
document.body.className = cfg.theme === 'light' ? 'light' : '';

function toggleTheme(){
document.body.classList.toggle('light');
cfg.theme=document.body.classList.contains('light')?'light':'dark';
localStorage.setItem('cfg',JSON.stringify(cfg));
}

/* ================= M3U PARSER ================= */
let channels=[], groups=[];
function parseM3U(txt){
channels=[];groups=[];
let cur=null;
txt.split(/\r?\n/).forEach(l=>{
l=l.trim();
if(l.startsWith('#EXTINF')){
const n=l.match(/,(.*)$/);
const g=l.match(/group-title="([^"]+)"/i);
const logo=l.match(/tvg-logo="([^"]+)"/i);
cur={
id:Math.random(),
name:n?n[1]:'Unknown',
group:g?g[1]:'Uncategorized',
logo:logo?logo[1]:'',
url:''
};
if(!groups.includes(cur.group)) groups.push(cur.group);
}
else if(cur && l.match(/^(http|rtmp|rtsp)/i)){
cur.url=l;
channels.push(cur);
cur=null;
}
});
}

/* ================= LOAD ================= */
async function loadM3U(url){
const txt=await fetch(url).then(r=>r.text());
parseM3U(txt);
render();
}

/* ================= UI ================= */
function render(){
playlist.innerHTML='';
groups.forEach(g=>{
playlist.innerHTML+=`<div class="category">${g}</div>`;
channels.filter(c=>c.group===g).forEach(c=>{
const i=channels.indexOf(c);
const d=document.createElement('div');
d.className='channel';d.tabIndex=0;
d.innerHTML=`<img src="${c.logo}" onerror="this.src='https://via.placeholder.com/48'">${c.name}`;
d.onclick=()=>playIndex(i);
playlist.appendChild(d);
});
});
}

/* ================= PLAYER FIX ================= */
let hls=null,current=-1;
function playIndex(i){
if(i<0||i>=channels.length) return;
current=i;
playChannel(channels[i]);
showZap(channels[i],i);
}

function playChannel(ch){
const v=video;
v.pause();
v.src='';
v.muted=true;

if(hls){hls.destroy();hls=null;}

const isHls = ch.url.includes('.m3u8');

if(isHls && window.Hls && Hls.isSupported()){
hls=new Hls({lowLatencyMode:true});
hls.attachMedia(v);
hls.on(Hls.Events.MEDIA_ATTACHED,()=>{
hls.loadSource(ch.url);
});
hls.on(Hls.Events.ERROR,(e,d)=>{
if(d.fatal) showError("HLS Error / Jaringan");
});
}else{
v.src=ch.url;
}

v.onerror=()=>showError("Tidak bisa memutar stream");
v.onstalled=()=>showError("Stream terhenti");
v.onwaiting=()=>console.log("Buffering");

v.play().catch(()=>showError("Autoplay diblokir"));
}

/* ================= ZAP ================= */
function showZap(c,i){
zapLogo.src=c.logo||'https://via.placeholder.com/64';
zapName.innerText=(i+1)+'. '+c.name;
zapGroup.innerText=c.group;
zap.classList.add('show');
setTimeout(()=>zap.classList.remove('show'),2500);
}

/* ================= ERROR ================= */
function showError(msg){
errorMsg.innerText=msg;
error.style.display='flex';
}
function zapNext(){
error.style.display='none';
playIndex(current+1);
}

/* ================= REMOTE ================= */
document.addEventListener('keydown',e=>{
if(e.key==='ArrowUp') playIndex(current-1);
if(e.key==='ArrowDown') playIndex(current+1);
});

/* AUTO LOAD */
if(cfg.m3u) loadM3U(cfg.m3u);
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>IPTV Player Ultimate</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
:root {
    --bg: #0f172a;
    --fg: #e5e7eb;
    --card: #020617;
    --accent: #2563eb;
}
.light {
    --bg: #f8fafc;
    --fg: #020617;
    --card: #e5e7eb;
    --accent: #2563eb;
}
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: var(--bg);
    color: var(--fg);
}
header {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    background: var(--card);
}
button {
    background: var(--accent);
    border: none;
    color: white;
    padding: 6px 10px;
    border-radius: 5px;
}
#container {
    display: flex;
    height: calc(100vh - 90px);
}
#playlist {
    width: 300px;
    overflow-y: auto;
}
.category {
    padding: 6px;
    background: var(--card);
    font-weight: bold;
}
.channel {
    display: flex;
    gap: 8px;
    padding: 6px;
    cursor: pointer;
}
.channel:hover { background: rgba(0,0,0,0.1); }
.channel img {
    width: 32px;
    height: 32px;
}
#player {
    flex: 1;
}
video {
    width: 100%;
    height: 100%;
    background: black;
}
#epg {
    padding: 6px;
    font-size: 13px;
    background: var(--card);
}
footer {
    text-align: center;
    font-size: 12px;
    background: var(--card);
    padding: 6px;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.6);
    justify-content: center;
    align-items: center;
}
.modal-content {
    background: var(--card);
    padding: 15px;
    border-radius: 8px;
    width: 320px;
}
input {
    width: 100%;
    margin-top: 8px;
    padding: 6px;
}
</style>
</head>

<body>

<header>
    <b>üì∫ IPTV Ultimate</b>
    <div>
        <button onclick="toggleTheme()">üåô/‚òÄÔ∏è</button>
        <button onclick="openSettings()">‚öôÔ∏è</button>
        <button onclick="logout()">üîê</button>
    </div>
</header>

<div id="container">
    <div id="playlist"></div>
    <div id="player">
        <video id="video" controls autoplay></video>
        <div id="epg">EPG: -</div>
    </div>
</div>

<footer>
Creativityright by M. Thorik - Donasi DANA 087888879016
</footer>

<!-- SETTINGS -->
<div class="modal" id="settings">
<div class="modal-content">
<h3>Settings</h3>
<input id="m3u" placeholder="URL M3U">
<input id="xmltv" placeholder="URL XMLTV (EPG)">
<input id="newPin" placeholder="PIN Baru">
<button onclick="saveSettings()" style="width:100%;margin-top:8px">Simpan</button>
</div>
</div>

<!-- PIN -->
<div class="modal" id="pin">
<div class="modal-content">
<h3>Masukkan PIN</h3>
<input id="pinInput" type="password">
<button onclick="checkPIN()" style="width:100%;margin-top:8px">Masuk</button>
</div>
</div>

<script>
/* CONFIG */
let cfg = JSON.parse(localStorage.getItem('cfg')) || {
    pin: "1234",
    theme: "dark",
    m3u: "",
    xmltv: ""
};
document.body.className = cfg.theme === "light" ? "light" : "";

/* PIN */
function checkPIN(){
    if(pinInput.value === cfg.pin){
        pin.style.display='none';
        if(cfg.m3u) loadM3U(cfg.m3u);
        if(cfg.xmltv) loadEPG(cfg.xmltv);
    } else alert("PIN salah");
}
function logout(){ pin.style.display='flex'; }

/* THEME */
function toggleTheme(){
    document.body.classList.toggle('light');
    cfg.theme = document.body.classList.contains('light') ? "light" : "dark";
    saveCfg();
}

/* SETTINGS */
function openSettings(){ settings.style.display='flex'; }
function saveSettings(){
    if(m3u.value) cfg.m3u = m3u.value;
    if(xmltv.value) cfg.xmltv = xmltv.value;
    if(newPin.value) cfg.pin = newPin.value;
    saveCfg();
    settings.style.display='none';
    loadM3U(cfg.m3u);
    loadEPG(cfg.xmltv);
}
function saveCfg(){
    localStorage.setItem('cfg', JSON.stringify(cfg));
}

/* M3U */
async function loadM3U(url){
    const t = await fetch(url).then(r=>r.text());
    parseM3U(t);
}
function parseM3U(txt){
    playlist.innerHTML="";
    let lines=txt.split('\n'), cat={}, cur={};
    lines.forEach(l=>{
        if(l.startsWith("#EXTINF")){
            cur={
                name:l.split(',').pop(),
                group:(l.match(/group-title="([^"]+)"/)||[])[1]||"Lainnya",
                logo:(l.match(/tvg-logo="([^"]+)"/)||[])[1]||""
            };
        } else if(l.startsWith("http")){
            cur.url=l.trim();
            cat[cur.group]=cat[cur.group]||[];
            cat[cur.group].push({...cur});
        }
    });
    for(let g in cat){
        playlist.innerHTML+=`<div class="category">${g}</div>`;
        cat[g].forEach(c=>{
            let d=document.createElement('div');
            d.className="channel";
            d.innerHTML=`<img src="${c.logo}" onerror="this.src='https://via.placeholder.com/32'">${c.name}`;
            d.onclick=()=>play(c.url,c.name);
            playlist.appendChild(d);
        });
    }
}

/* PLAYER */
let hls;
function play(url,name){
    epg.innerText="EPG: loading...";
    if(Hls.isSupported()){
        if(hls)hls.destroy();
        hls=new Hls();
        hls.loadSource(url);
        hls.attachMedia(video);
    } else video.src=url;
    showEPG(name);
}

/* EPG */
let epgData=[];
async function loadEPG(url){
    const xml=await fetch(url).then(r=>r.text());
    const doc=new DOMParser().parseFromString(xml,"text/xml");
    epgData=[...doc.querySelectorAll("programme")];
}
function showEPG(ch){
    let now=new Date();
    let p=epgData.find(e=>{
        let s=parseEPG(e.getAttribute("start"));
        let en=parseEPG(e.getAttribute("stop"));
        return e.getAttribute("channel")?.includes(ch)&&now>=s&&now<=en;
    });
    epg.innerText=p?`EPG: ${p.querySelector("title").textContent}`:"EPG: Tidak tersedia";
}
function parseEPG(t){
    return new Date(t.substr(0,4),t.substr(4,2)-1,t.substr(6,2),t.substr(8,2),t.substr(10,2));
}

/* INIT */
pin.style.display='flex';
</script>

</body>
</html>

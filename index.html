<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>M-TIVI - SMART TV EDITION</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.10"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #10b981;
      --bg-dark: #050505;
      --card-bg: #111111;
    }
    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background-color: var(--bg-dark);
      color: white;
      overflow: hidden;
      height: 100vh;
      margin: 0;
    }
    .sidebar-item:hover { background: rgba(16, 185, 129, 0.1); }
    .sidebar-item.active { background: var(--primary); color: white; box-shadow: 0 0 25px rgba(16, 185, 129, 0.3); }
    .channel-card:hover { transform: scale(1.03); z-index: 10; border-color: var(--primary); }
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }

    /* Channel grid scrollbar */
    #channel-grid {
      scrollbar-width: thin;
      scrollbar-color: #333 #111;
    }
    #channel-grid::-webkit-scrollbar {
      width: 6px;
    }
    #channel-grid::-webkit-scrollbar-track {
      background: #111;
    }
    #channel-grid::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 3px;
    }
    #channel-grid::-webkit-scrollbar-thumb:hover {
      background: var(--primary);
    }
  </style>
</head>
<body class="flex flex-col">

<!-- SPLASH SCREEN -->
<div id="startup-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-gray-900 z-50">
  <div class="text-center">
    <h1 class="text-4xl font-bold text-white mb-6">M-TIVI</h1>
    <p class="text-green-400 mb-8">SMART TV EDITION</p>
    <button id="btn-upload" class="px-6 py-3 bg-gray-800 hover:bg-gray-700 rounded-lg text-white mb-3 w-64">üìÅ Upload M3U</button>
    <button id="btn-url" class="px-6 py-3 bg-gray-800 hover:bg-gray-700 rounded-lg text-white w-64">üîó Masukkan URL Playlist</button>
    <input type="file" id="file-input" accept=".m3u,.m3u8" hidden />
    <div id="url-input-group" class="mt-4 hidden">
      <input type="text" id="playlist-url" placeholder="https://contoh.com/playlist.m3u" class="w-64 px-4 py-2 bg-gray-800 text-white rounded mb-2" />
      <button id="btn-load-url" class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded text-white">Muat</button>
    </div>
    <div id="error-message" class="mt-4 text-red-400 min-h-6"></div>
  </div>
</div>

<!-- MAIN APP -->
<div id="app" class="hidden flex flex-col h-full">
  <!-- Navbar -->
  <div class="h-14 px-6 flex items-center justify-between glass border-b border-gray-800 bg-black bg-opacity-30 backdrop-blur">
    <div class="text-xl font-bold text-green-400">M-TIVI</div>
    <div id="playlist-name" class="text-sm text-gray-400 truncate max-w-xs"></div>
    <div class="flex items-center gap-3">
      <input type="text" id="search" placeholder="Cari channel..." class="px-3 py-1 bg-gray-800 rounded text-sm w-48" />
      <button id="settings-btn" class="text-xl">‚öôÔ∏è</button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="flex flex-1 overflow-hidden">
    <!-- Sidebar Groups -->
    <div id="groups-panel" class="w-48 p-3 overflow-y-auto custom-scrollbar bg-gray-900 border-r border-gray-800"></div>

    <!-- Channels + Player -->
    <div class="flex-1 flex flex-col">
      <!-- Video Player -->
      <div id="video-player" class="h-1/2 relative">
        <video id="player" class="w-full h-full object-contain bg-black" controls playsinline></video>
        <div id="player-loading" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-70 text-green-400 hidden">Memuat stream...</div>
        <div id="player-error" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-80 text-red-400 text-center p-4 hidden"></div>
      </div>

      <!-- Channel Grid -->
      <div id="channel-grid" class="flex-1 p-4 overflow-y-auto grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3 custom-scrollbar"></div>
    </div>
  </div>

  <!-- Footer -->
  <div class="h-10 px-6 flex items-center justify-center text-xs text-gray-500 bg-black bg-opacity-50 border-t border-gray-800">
    üíñ Creativityright by tHoRicQ | Dukung Pengembangan
  </div>
</div>

<script>
let channels = [];
let groups = [];
let currentChannelIndex = -1;
let currentPlaylistName = "Playlist";

// === DOM Elements ===
const startupScreen = document.getElementById('startup-screen');
const app = document.getElementById('app');
const fileInput = document.getElementById('file-input');
const playlistUrlInput = document.getElementById('playlist-url');
const playlistNameEl = document.getElementById('playlist-name');
const searchInput = document.getElementById('search');
const groupsPanel = document.getElementById('groups-panel');
const channelGrid = document.getElementById('channel-grid');
const player = document.getElementById('player');
const playerLoading = document.getElementById('player-loading');
const playerError = document.getElementById('player-error');
const errorMessage = document.getElementById('error-message');

// === Parse M3U ===
function parseM3U(text) {
  const lines = text.split('\n');
  const list = [];
  let current = null;

  for (let line of lines) {
    line = line.trim();
    if (line.startsWith('#EXTINF:')) {
      const logoMatch = line.match(/tvg-logo=["']?([^"'>\s]+)/i);
      const groupMatch = line.match(/group-title=["']?([^"'>]+)/i);
      const name = line.split(/,(.+)/).pop()?.trim() || 'Channel';

      current = {
        name: name,
        url: '',
        logo: logoMatch ? logoMatch[1].trim() : '',
        group: groupMatch ? groupMatch[1].trim().replace(/["']/g, '') : 'Umum'
      };
    } else if (line && !line.startsWith('#') && current) {
      current.url = line.trim();
      if (current.url) {
        list.push(current);
      }
      current = null;
    }
  }
  return list;
}

// === Render Channel ===
function renderChannels(list) {
  channelGrid.innerHTML = '';
  if (list.length === 0) {
    channelGrid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10">Tidak ada channel.</div>';
    return;
  }

  list.forEach((ch, index) => {
    const el = document.createElement('div');
    el.className = 'channel-card bg-gray-800 rounded-lg p-3 flex items-center gap-3 cursor-pointer border border-transparent transition-all duration-200';
    if (index === currentChannelIndex) el.classList.add('border-green-500');

    let logoHtml = '';
    if (ch.logo && ch.logo.trim() !== '') {
      let logoUrl = ch.logo;
      if (!logoUrl.startsWith('http') && !logoUrl.startsWith('//')) {
        logoUrl = 'https://' + logoUrl;
      }
      logoHtml = `<img src="${logoUrl}" onerror="this.style.display='none'" class="w-10 h-10 rounded object-cover flex-shrink-0" />`;
    }

    el.innerHTML = `
      ${logoHtml}
      <span class="text-sm font-medium truncate">${ch.name}</span>
    `;
    el.onclick = () => playChannel(ch, index);
    channelGrid.appendChild(el);
  });
}

// === Load Playlist ===
function loadPlaylist(list, name) {
  if (list.length === 0) {
    showError("‚ùå Tidak ada channel valid.");
    return;
  }
  channels = list;
  currentPlaylistName = name;
  const groupSet = new Set(list.map(c => c.group));
  groups = Array.from(groupSet).sort();
  startupScreen.classList.add('hidden');
  app.classList.remove('hidden');
  playlistNameEl.textContent = name;
  renderGroups();
  renderChannels(list);
  cleanupPlayer();
  hidePlayerError();
}

function renderGroups() {
  groupsPanel.innerHTML = '';
  groups.forEach(group => {
    const el = document.createElement('div');
    el.className = 'sidebar-item px-3 py-2 rounded cursor-pointer text-sm mb-1';
    el.textContent = group;
    el.onclick = () => {
      document.querySelectorAll('.sidebar-item').forEach(g => g.classList.remove('active'));
      el.classList.add('active');
      const filtered = channels.filter(c => c.group === group);
      renderChannels(filtered);
    };
    groupsPanel.appendChild(el);
  });
  if (groupsPanel.firstChild) groupsPanel.firstChild.classList.add('active');
}

function cleanupPlayer() {
  if (player.hls) {
    player.hls.destroy();
    player.hls = null;
  }
  player.innerHTML = '';
  player.src = '';
}

function showError(msg) {
  errorMessage.textContent = msg;
  setTimeout(() => { errorMessage.textContent = ""; }, 5000);
}

function showPlayerError(msg) {
  playerLoading.classList.add('hidden');
  playerError.textContent = msg;
  playerError.classList.remove('hidden');
  player.classList.add('hidden');
}

function hidePlayerError() {
  playerError.classList.add('hidden');
  player.classList.remove('hidden');
}

// ‚úÖ HLS PLAYER YANG SUDAH DIPERBAIKI
function playChannel(channel, index) {
  currentChannelIndex = index;
  document.querySelectorAll('.channel-card').forEach((el, i) => {
    el.classList.toggle('border-green-500', i === index);
  });

  cleanupPlayer();
  hidePlayerError();
  playerLoading.classList.remove('hidden');

  const url = channel.url.trim();

  // Hanya tangani HLS jika URL berakhir dengan .m3u8
  if (url.endsWith('.m3u8')) {
    if (Hls.isSupported()) {
      const hls = new Hls({
        enableWorker: false,
        lowLatencyMode: false,
        backBufferLength: 30
      });
      player.hls = hls;
      hls.loadSource(url);
      hls.attachMedia(player);

      hls.on(Hls.Events.MANIFEST_PARSED, () => {
        playerLoading.classList.add('hidden');
        // Jangan autoplay ‚Äî biarkan user klik play
      });

      hls.on(Hls.Events.ERROR, (event, data) => {
        console.error("HLS Error:", data);
        let msg = "‚ùå Gagal memuat stream.";
        if (data.fatal) {
          if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
            msg = "‚ùå Kesalahan jaringan. Periksa URL atau koneksi internet.";
          } else if (data.type === Hls.ErrorTypes.MEDIA_ERROR) {
            msg = "‚ùå Format media tidak didukung.";
          }
          hls.destroy();
          showPlayerError(msg);
        }
      });
    } else if (player.canPlayType('application/vnd.apple.mpegurl')) {
      // Safari
      player.src = url;
      player.onloadstart = () => { playerLoading.classList.add('hidden'); };
      player.onerror = () => {
        showPlayerError("‚ùå Gagal memuat HLS di perangkat ini.");
      };
    } else {
      showPlayerError("‚ùå HLS tidak didukung oleh browser ini.");
    }
  } else {
    // Non-HLS: MP4, WebM, dll
    player.src = url;
    player.onloadstart = () => { playerLoading.classList.add('hidden'); };
    player.onerror = () => {
      showPlayerError("‚ùå Gagal memuat video langsung.");
    };
  }
}

// === Event Listeners ===
document.getElementById('btn-upload').onclick = () => fileInput.click();
document.getElementById('btn-url').onclick = () => {
  document.getElementById('url-input-group').classList.remove('hidden');
};
document.getElementById('btn-load-url').onclick = () => {
  const url = playlistUrlInput.value.trim();
  if (!url) { showError("‚ö†Ô∏è URL tidak boleh kosong!"); return; }
  fetch(url)
    .then(res => res.ok ? res.text() : Promise.reject(new Error(`HTTP ${res.status}`)))
    .then(text => {
      const list = parseM3U(text);
      const filename = url.split('/').pop() || 'remote_playlist.m3u';
      loadPlaylist(list, filename);
    })
    .catch(err => { showError(`‚ùå Gagal: ${err.message}`); });
};
fileInput.onchange = (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    const list = parseM3U(ev.target.result);
    loadPlaylist(list, file.name);
  };
  reader.readAsText(file);
};

searchInput.oninput = (e) => {
  const q = e.target.value.toLowerCase();
  const filtered = channels.filter(c => c.name.toLowerCase().includes(q));
  renderChannels(filtered);
});

startupScreen.classList.remove('hidden');
</script>

</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>IQ-TV</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- HLS.JS -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
/* ================== CORE ================== */
body {
    margin: 0;
    background: #0f0c14;
    color: #fff;
    font-family: Segoe UI, sans-serif;
}
.hidden { display: none; }

/* ================== LAYOUT ================== */
.container { display: flex; height: 100vh; }
.sidebar {
    width: 230px;
    background: #09070c;
    overflow-y: auto;
}
.menu-item, .clear-playlist {
    padding: 14px;
    cursor: pointer;
}
.menu-item.active { background: #1e1a24; }
.clear-playlist { color: #e17055; }

.main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
}
.header {
    padding: 10px 15px;
    display: flex;
    justify-content: space-between;
    border-bottom: 1px solid #222;
}
.search-bar input {
    background: #14101a;
    border: none;
    color: #fff;
    padding: 6px 10px;
}

.video-player {
    height: 380px;
    background: black;
}
.actual-video-player {
    width: 100%;
    height: 100%;
    background: black;
}

.channels-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill,minmax(160px,1fr));
    gap: 12px;
    padding: 15px;
}
.channel-card {
    background: #14101a;
    padding: 12px;
    cursor: pointer;
    border-radius: 8px;
}
.channel-card:hover { background: #1e1a24; }

/* ================== UPLOAD ================== */
.upload-screen {
    height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}
.upload-option {
    background: #14101a;
    padding: 20px;
    margin: 10px;
    cursor: pointer;
}
.file-input { display: none; }
</style>
</head>

<body>

<!-- ================== UPLOAD ================== -->
<div id="upload-screen" class="upload-screen">
    <h1>IQ-TV</h1>

    <div class="upload-option" id="upload-file-option">üìÅ Upload M3U</div>
    <div class="upload-option" id="url-option">üîó URL M3U</div>

    <div id="upload-form" class="hidden">
        <input type="file" id="m3u-file" class="file-input" accept=".m3u,.m3u8">
        <input type="text" id="m3u-url" placeholder="https://example.com/list.m3u">
        <br><br>
        <button id="upload-submit">Mulai</button>
        <p id="url-error" style="color:red"></p>
    </div>
</div>

<!-- ================== APP ================== -->
<div id="app-container" class="container hidden">

    <div class="sidebar">
        <div class="menu-item active" data-category="all">Semua</div>
        <div class="menu-item" data-category="news">News</div>
        <div class="menu-item" data-category="sports">Sports</div>
        <div class="menu-item" data-category="movies">Movies</div>
        <div class="menu-item" data-category="religious">Religious</div>
        <div class="clear-playlist" id="clear-playlist">üóë Clear</div>
    </div>

    <div class="main-content">
        <div class="header">
            <div id="playlist-title">playlist.m3u</div>
            <div class="search-bar">
                <input id="search-input" placeholder="Search channel">
            </div>
        </div>

        <div id="video-player" class="video-player">
            <div style="padding:20px">Pilih channel</div>
        </div>

        <div class="channels-grid" id="channels-grid"></div>
    </div>
</div>

<script>
/* ================== STATE ================== */
let currentPlaylist = [];
let filteredChannels = [];
let currentCategory = 'all';
let hlsInstance = null;

/* ================== ELEMENTS ================== */
const uploadScreen = document.getElementById('upload-screen');
const appContainer = document.getElementById('app-container');
const uploadForm = document.getElementById('upload-form');
const uploadFileOption = document.getElementById('upload-file-option');
const urlOption = document.getElementById('url-option');
const m3uFile = document.getElementById('m3u-file');
const m3uUrl = document.getElementById('m3u-url');
const uploadSubmit = document.getElementById('upload-submit');
const channelsGrid = document.getElementById('channels-grid');
const videoPlayer = document.getElementById('video-player');
const searchInput = document.getElementById('search-input');
const playlistTitle = document.getElementById('playlist-title');

/* ================== INIT ================== */
uploadFileOption.onclick = () => {
    uploadForm.classList.remove('hidden');
    m3uFile.click();
};
urlOption.onclick = () => uploadForm.classList.remove('hidden');

uploadSubmit.onclick = () => {
    if (m3uFile.files.length) readFile(m3uFile.files[0]);
    else if (m3uUrl.value) fetchUrl(m3uUrl.value);
};

/* ================== PARSER ================== */
function parseM3U(text) {
    const lines = text.split('\n');
    const list = [];
    let ch = null;

    lines.forEach(l => {
        l = l.trim();
        if (l.startsWith('#EXTINF')) {
            const name = l.split(',').pop();
            const group = (l.match(/group-title="([^"]+)"/)||[])[1] || 'undefined';
            ch = { name, category: group.toLowerCase(), url: '' };
        } else if (l && !l.startsWith('#') && ch) {
            ch.url = l;
            list.push(ch);
            ch = null;
        }
    });
    return list;
}

/* ================== LOAD ================== */
function readFile(file) {
    const r = new FileReader();
    r.onload = e => loadPlaylist(parseM3U(e.target.result), file.name);
    r.readAsText(file);
}

function fetchUrl(url) {
    fetch(url)
        .then(r => r.text())
        .then(t => loadPlaylist(parseM3U(t), url.split('/').pop()))
        .catch(() => alert('CORS / URL gagal'));
}

function loadPlaylist(list, name) {
    currentPlaylist = list;
    filteredChannels = list;
    playlistTitle.textContent = name;

    localStorage.setItem('iqtv_playlist', JSON.stringify(list));
    localStorage.setItem('iqtv_playlist_name', name);

    uploadScreen.classList.add('hidden');
    appContainer.classList.remove('hidden');
    renderChannels();
}

/* ================== RENDER ================== */
function renderChannels() {
    channelsGrid.innerHTML = '';
    filteredChannels.forEach(c => {
        const d = document.createElement('div');
        d.className = 'channel-card';
        d.innerText = c.name;
        d.onclick = () => playChannel(c);
        channelsGrid.appendChild(d);
    });
}

/* ================== PLAYER ================== */
function playChannel(channel) {
    videoPlayer.innerHTML = `<video id="video" class="actual-video-player" controls autoplay></video>`;
    const video = document.getElementById('video');

    if (hlsInstance) { hlsInstance.destroy(); hlsInstance = null; }

    if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = channel.url;
        enableTracks(video);
    } else if (Hls.isSupported()) {
        hlsInstance = new Hls();
        hlsInstance.loadSource(channel.url);
        hlsInstance.attachMedia(video);

        hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => {
            if (hlsInstance.audioTracks.length) hlsInstance.audioTrack = 0;
            if (hlsInstance.subtitleTracks.length) hlsInstance.subtitleTrack = 0;
        });
    }

    enhancePlayer(video);
}

function enableTracks(video) {
    for (const t of video.textTracks) t.mode = 'showing';
}

function enhancePlayer(video) {
    video.ondblclick = () => video.requestFullscreen();
    document.onkeydown = e => {
        if (e.key === 'p' && document.pictureInPictureEnabled)
            video.requestPictureInPicture();
    };
}

/* ================== SEARCH ================== */
searchInput.oninput = () => {
    const q = searchInput.value.toLowerCase();
    filteredChannels = currentPlaylist.filter(c => c.name.toLowerCase().includes(q));
    renderChannels();
};

/* ================== CLEAR ================== */
document.getElementById('clear-playlist').onclick = () => {
    localStorage.clear();
    location.reload();
};

/* ================== AUTO LOAD ================== */
const saved = localStorage.getItem('iqtv_playlist');
if (saved) {
    loadPlaylist(JSON.parse(saved), localStorage.getItem('iqtv_playlist_name'));
}
</script>

</body>
</html>
